
%\VignetteIndexEntry{matter: Rapid prototyping with data on disk}
%\VignetteKeyword{Infrastructure}

\documentclass[a4paper]{article}
\usepackage{caption}
\usepackage{subcaption}


\RequirePackage{/Users/kuwisdelu/Library/R/3.3/library/BiocStyle/resources/tex/Bioconductor}

\AtBeginDocument{\bibliographystyle{/Users/kuwisdelu/Library/R/3.3/library/BiocStyle/resources/tex/unsrturl}}
\title{\Rpackage{matter}: Rapid prototyping with data on disk}

\author{Kylie A. Bemis}

\usepackage{Sweave}
\begin{document}
\input{matter-concordance}

\maketitle

\tableofcontents

\section{Introduction}


Text text text text text text.

\begin{Schunk}
\begin{Sinput}
> x <- matter_mat(data=1:50, nrow=10, ncol=5)
> x
\end{Sinput}
\begin{Soutput}
An object of class 'matter_matc'
  <10 row, 5 column> on-disk binary matrix
    files: 1
    datamode: numeric
    16.5 KB in-memory
    400 bytes on-disk
\end{Soutput}
\begin{Sinput}
> x[]
\end{Sinput}
\begin{Soutput}
      [,1] [,2] [,3] [,4] [,5]
 [1,]    1   11   21   31   41
 [2,]    2   12   22   32   42
 [3,]    3   13   23   33   43
 [4,]    4   14   24   34   44
 [5,]    5   15   25   35   45
 [6,]    6   16   26   36   46
 [7,]    7   17   27   37   47
 [8,]    8   18   28   38   48
 [9,]    9   19   29   39   49
[10,]   10   20   30   40   50
\end{Soutput}
\begin{Sinput}
> rownames(x) <- 1:10
> colnames(x) <- letters[1:5]
> x[1:4,]
\end{Sinput}
\begin{Soutput}
  a  b  c  d  e
1 1 11 21 31 41
2 2 12 22 32 42
3 3 13 23 33 43
4 4 14 24 34 44
\end{Soutput}
\begin{Sinput}
> x[,3:4]
\end{Sinput}
\begin{Soutput}
    c  d
1  21 31
2  22 32
3  23 33
4  24 34
5  25 35
6  26 36
7  27 37
8  28 38
9  29 39
10 30 40
\end{Soutput}
\begin{Sinput}
> colSums(x)
\end{Sinput}
\begin{Soutput}
  a   b   c   d   e 
 55 155 255 355 455 
\end{Soutput}
\begin{Sinput}
> colSums(x[])
\end{Sinput}
\begin{Soutput}
  a   b   c   d   e 
 55 155 255 355 455 
\end{Soutput}
\begin{Sinput}
> colVar(x)
\end{Sinput}
\begin{Soutput}
       a        b        c        d        e 
9.166667 9.166667 9.166667 9.166667 9.166667 
\end{Soutput}
\begin{Sinput}
> apply(x, 2, var)
\end{Sinput}
\begin{Soutput}
       a        b        c        d        e 
9.166667 9.166667 9.166667 9.166667 9.166667 
\end{Soutput}
\begin{Sinput}
> y <- matter_mat(data=51:100, nrow=10, ncol=5)
> filepath(x)
\end{Sinput}
\begin{Soutput}
[1] "/var/folders/bf/tcngbyjj6kn540c74_kf6ypw0000gp/T//RtmpHr6nOb/filee7d95374ecb4.bin"
\end{Soutput}
\begin{Sinput}
> filepath(y)
\end{Sinput}
\begin{Soutput}
[1] "/var/folders/bf/tcngbyjj6kn540c74_kf6ypw0000gp/T//RtmpHr6nOb/filee7d957d6126c.bin"
\end{Soutput}
\begin{Sinput}
> z <- cbind(x, y)
> z
\end{Sinput}
\begin{Soutput}
An object of class 'matter_matc'
  <10 row, 10 column> on-disk binary matrix
    files: 2
    datamode: numeric
    33 KB in-memory
    800 bytes on-disk
\end{Soutput}
\begin{Sinput}
> z[]
\end{Sinput}
\begin{Soutput}
    a  b  c  d  e                
1   1 11 21 31 41 51 61 71 81  91
2   2 12 22 32 42 52 62 72 82  92
3   3 13 23 33 43 53 63 73 83  93
4   4 14 24 34 44 54 64 74 84  94
5   5 15 25 35 45 55 65 75 85  95
6   6 16 26 36 46 56 66 76 86  96
7   7 17 27 37 47 57 67 77 87  97
8   8 18 28 38 48 58 68 78 88  98
9   9 19 29 39 49 59 69 79 89  99
10 10 20 30 40 50 60 70 80 90 100
\end{Soutput}
\begin{Sinput}
> try(rbind(x, y))
> t(x)
\end{Sinput}
\begin{Soutput}
An object of class 'matter_matr'
  <5 row, 10 column> on-disk binary matrix
    files: 1
    datamode: numeric
    16.8 KB in-memory
    400 bytes on-disk
\end{Soutput}
\begin{Sinput}
> rbind(t(x), t(y))
\end{Sinput}
\begin{Soutput}
An object of class 'matter_matr'
  <10 row, 10 column> on-disk binary matrix
    files: 2
    datamode: numeric
    33 KB in-memory
    800 bytes on-disk
\end{Soutput}
\begin{Sinput}
> x@data
\end{Sinput}
\begin{Soutput}
[[1]]
  file_id datamode offset extent index_offset index_extent
1       1   double      0     10            0           10

[[2]]
  file_id datamode offset extent index_offset index_extent
1       1   double     80     10            0           10

[[3]]
  file_id datamode offset extent index_offset index_extent
1       1   double    160     10            0           10

[[4]]
  file_id datamode offset extent index_offset index_extent
1       1   double    240     10            0           10

[[5]]
  file_id datamode offset extent index_offset index_extent
1       1   double    320     10            0           10
\end{Soutput}
\begin{Sinput}
> xsub <- matter_mat(offset=c(40, 120, 200, 280,360),
+             extent=rep(5,5), filepath=filepath(x))
> x[6:10,]
\end{Sinput}
\begin{Soutput}
    a  b  c  d  e
6   6 16 26 36 46
7   7 17 27 37 47
8   8 18 28 38 48
9   9 19 29 39 49
10 10 20 30 40 50
\end{Soutput}
\begin{Sinput}
> xsub[]
\end{Sinput}
\begin{Soutput}
     [,1] [,2] [,3] [,4] [,5]
[1,]    6   16   26   36   46
[2,]    7   17   27   37   47
[3,]    8   18   28   38   48
[4,]    9   19   29   39   49
[5,]   10   20   30   40   50
\end{Soutput}
\end{Schunk}


\section{Examples}

\begin{Schunk}
\begin{Sinput}
> set.seed(81216)
> n <- 15e6
> p <- 9
> b <- runif(p)
> names(b) <- paste0("x", 1:p)
> data <- matter_mat(nrow=n, ncol=p + 1)
> colnames(data) <- c(names(b), "y")
> data[,p + 1] <- 0
> for ( i in 1:p ) {
+   xi <- rnorm(n)
+   data[,i] <- xi
+   data[,p + 1] <- data[,p + 1] + xi * b[i]
+ }
> data
\end{Sinput}
\begin{Soutput}
An object of class 'matter_matc'
  <15000000 row, 10 column> on-disk binary matrix
    files: 1
    datamode: numeric
    31.2 KB in-memory
    1.2 GB on-disk
\end{Soutput}
\begin{Sinput}
> head(data)
\end{Sinput}
\begin{Soutput}
             x1          x2        x3         x4          x5         x6         x7         x8
[1,] 0.97662048 -0.45330471 0.5995144 -0.1392395  0.36748584  1.4000923  0.5555708 -2.4031764
[2,] 0.59181550 -1.60355974 0.5862366 -0.5421275 -0.36101120 -0.4930582  0.7549443 -0.1348020
[3,] 1.58542633  0.22920974 0.5138377 -1.7860077  1.53126322  0.3557548 -0.6093811  1.0381120
[4,] 0.56940204 -1.38862865 0.1411892  0.3166607 -0.08396404  0.9629351  0.3443397 -1.5310565
[5,] 0.41764079 -0.36473656 0.4315282  1.1860328 -1.13518455  0.5386445  1.1426125  0.2239818
[6,] 0.07936079 -0.07204838 0.2744724 -0.6730541  0.03472469  0.2138691  0.5923886  0.4852140
              x9           y
[1,] -0.57037899  0.06161175
[2,]  0.05384544 -1.46818344
[3,]  0.72976777  1.03571563
[4,] -0.44875206 -1.04267111
[5,]  1.40000992  2.25442283
[6,] -0.29082018  0.36035022
\end{Soutput}
\end{Schunk}

% for some reason colSums, colMeans, etc. don't work here
% need to find bug since they work for other matrices

\begin{Schunk}
\begin{Sinput}
> matter:::profile({
+   means <- apply(data, 2, mean)
+ })
\end{Sinput}
\begin{Soutput}
   start (MB)   finish (MB) max used (MB) overhead (MB)    time (sec) 
      148.900       148.900      1349.200      1200.300         1.659 
\end{Soutput}
\begin{Sinput}
> means
\end{Sinput}
\begin{Soutput}
           x1            x2            x3            x4            x5            x6            x7 
 4.246539e-04  2.962621e-04 -2.596339e-04 -2.729651e-04  3.014581e-05 -5.893552e-05 -2.835383e-04 
           x8            x9             y 
-1.309537e-04 -9.810476e-05 -2.880175e-04 
\end{Soutput}
\begin{Sinput}
> matter:::profile({
+   vars <- apply(data, 2, var)
+ })
\end{Sinput}
\begin{Soutput}
   start (MB)   finish (MB) max used (MB) overhead (MB)    time (sec) 
      148.900       148.900       869.100       720.200         1.855 
\end{Soutput}
\begin{Sinput}
> vars
\end{Sinput}
\begin{Soutput}
       x1        x2        x3        x4        x5        x6        x7        x8        x9         y 
1.0001935 1.0003094 0.9996336 0.9990518 1.0003654 0.9999593 0.9995961 0.9999286 1.0001395 3.4511645 
\end{Soutput}
\end{Schunk}

\begin{Schunk}
\begin{Sinput}
> fm <- as.formula(paste0("y ~ ", paste(names(b), collapse=" + ")))
> matter:::profile({
+   bigglm.out <- bigglm(fm, data=data, chunksize=floor(n / 100))
+ })
\end{Sinput}
\begin{Soutput}
   start (MB)   finish (MB) max used (MB) overhead (MB)    time (sec) 
      148.900       149.500       603.000       453.500        51.495 
\end{Soutput}
\begin{Sinput}
> summary(bigglm.out)
\end{Sinput}
\begin{Soutput}
Large data regression model: bigglm(formula, getNextDataChunk, ...)
Sample size =  1.5e+07 
              Coef   (95%    CI) SE      p
(Intercept) 0.0000 0.0000 0.0000  0 0.2263
x1          0.1689 0.1689 0.1689  0 0.0000
x2          0.9574 0.9574 0.9574  0 0.0000
x3          0.3802 0.3802 0.3802  0 0.0000
x4          0.6044 0.6044 0.6044  0 0.0000
x5          0.5195 0.5195 0.5195  0 0.0000
x6          0.6927 0.6927 0.6927  0 0.0000
x7          0.8374 0.8374 0.8374  0 0.0000
x8          0.4618 0.4618 0.4618  0 0.0000
x9          0.5775 0.5775 0.5775  0 0.0000
\end{Soutput}
\begin{Sinput}
> cbind(coef(bigglm.out)[-1], b)
\end{Sinput}
\begin{Soutput}
                     b
x1 0.1689486 0.1689486
x2 0.9574388 0.9574388
x3 0.3802078 0.3802078
x4 0.6043915 0.6043915
x5 0.5194832 0.5194832
x6 0.6927430 0.6927430
x7 0.8373628 0.8373628
x8 0.4617963 0.4617963
x9 0.5775168 0.5775168
\end{Soutput}
\end{Schunk}


Text text text text text text.



\section{Design and implementation}

Text text text text text text.



\section{Session info}

\begin{itemize}\raggedright
  \item R version 3.3.0 beta (2016-04-19 r70517), \verb|x86_64-apple-darwin13.4.0|
  \item Locale: \verb|en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8|
  \item Base packages: base, datasets, graphics, grDevices, methods, stats, utils
  \item Other packages: biglm~0.9-1, DBI~0.3.1, matter~0.4
  \item Loaded via a namespace (and not attached): BiocGenerics~0.16.1, BiocStyle~1.8.0,
    parallel~3.3.0, tools~3.3.0
\end{itemize}
% \bibliographystyle{unsrt}
% \bibliography{matter}

\end{document}
